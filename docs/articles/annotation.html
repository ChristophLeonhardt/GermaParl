<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corpus Preparation using CoreNLP • GermaParl</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">GermaParl</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/GermaParl.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/annotation.html">Corpus Preparation using CoreNLP</a>
    </li>
    <li>
      <a href="../articles/enhancements.html">Enhancements to the GermaParl Corpus</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Corpus Preparation using CoreNLP</h1>
                        <h4 class="author">Andreas Blätte (<a href="mailto:andreas.blaette@uni-due.de">andreas.blaette@uni-due.de</a>)</h4>
            
            <h4 class="date">2017-10-07</h4>
          </div>

    
    
<div class="contents">
<div id="setting-parameters-and-global-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-parameters-and-global-variables" class="anchor"></a>Setting parameters and global variables</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ctk)
<span class="kw">options</span>(<span class="dt">ctk.stanfordDir =</span> <span class="st">"/opt/stanford-corenlp/stanford-corenlp-full-2017-06-09"</span>)
<span class="kw">options</span>(<span class="dt">ctk.propertiesFile =</span> <span class="st">"/opt/stanford-corenlp/StanfordCoreNLP-german.properties"</span>)
<span class="kw">options</span>(<span class="st">"polmineR.cwb-regedit"</span> =<span class="st"> </span><span class="ot">TRUE</span>)
<span class="kw">options</span>(<span class="dt">java.parameters =</span> <span class="st">"-Xmx4g"</span>) <span class="co"># needs to be set before a JVM is initialized.</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">noCores &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>() <span class="op">-</span><span class="st"> </span>2L</code></pre></div>
</div>
<div id="initialize-pipe" class="section level1">
<h1 class="hasAnchor">
<a href="#initialize-pipe" class="anchor"></a>Initialize Pipe</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pipeDir &lt;-<span class="st"> "/hd/pipeDirs/GermaParl"</span>
<span class="co"># create subdirectories</span>
<span class="cf">for</span> (subdir <span class="cf">in</span> <span class="kw">c</span>(<span class="st">"xml"</span>, <span class="st">"csv"</span>, <span class="st">"tok"</span>, <span class="st">"ndjson"</span>, <span class="st">"vrt"</span>)){
  neededDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(pipeDir, subdir)
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(neededDir)){
    <span class="kw">dir.create</span>(neededDir)
  } <span class="cf">else</span> {
    filesToDelete &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">file.path</span>(pipeDir, subdir), <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    <span class="kw">lapply</span>(filesToDelete, file.remove)
  }
}
P &lt;-<span class="st"> </span>Pipe<span class="op">$</span><span class="kw">new</span>(<span class="dt">dir =</span> pipeDir, <span class="dt">threads =</span> noCores)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sourceDirs &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="st">"~/Lab/gitlab/plprbttxt_tei"</span>,
  <span class="st">"~/Lab/gitlab/plprbtpdf_tei"</span>
)
P<span class="op">$</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ctk/topics/getFiles">getFiles</a></span>(<span class="dt">sourceDir =</span> sourceDirs, <span class="dt">pattern =</span> <span class="st">"xml"</span>, <span class="dt">targetDir =</span> <span class="st">"xml"</span>)</code></pre></div>
</div>
<div id="generate-basetable" class="section level1">
<h1 class="hasAnchor">
<a href="#generate-basetable" class="anchor"></a>Generate Basetable</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">metadata &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">lp =</span> <span class="st">"//legislativePeriod"</span>,
  <span class="dt">session =</span> <span class="st">"//titleStmt/sessionNo"</span>,
  <span class="dt">date =</span> <span class="st">"//publicationStmt/date"</span>
)
P<span class="op">$</span><span class="kw">xmlToBasetable</span>(<span class="dt">metadata =</span> metadata) <span class="co"># 8min 30 s</span>
data.table<span class="op">::</span><span class="kw">fwrite</span>(P<span class="op">$</span>basetable, <span class="dt">file =</span> <span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"csv"</span>, <span class="st">"basetable.csv"</span>))</code></pre></div>
<p>Some adjustments and some cleaning.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="kw">is.null</span>(P<span class="op">$</span>basetable)){
  P<span class="op">$</span>basetable &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="dt">file =</span> <span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"csv"</span>, <span class="st">"basetable.csv"</span>))
}
P<span class="op">$</span>basetable &lt;-<span class="st"> </span>P<span class="op">$</span>basetable[<span class="kw">is.na</span>(speaker)][, speaker <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>] <span class="co"># remove text in speaker tag</span>
P<span class="op">$</span>basetable[, id <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(P<span class="op">$</span>basetable)] <span class="co"># add column with ids</span>
<span class="cf">for</span> (x <span class="cf">in</span> <span class="kw">c</span>(<span class="st">"div_what"</span>, <span class="st">"div_desc"</span>, <span class="st">"body"</span>, <span class="st">"TEI"</span>, <span class="st">"p"</span>)) P<span class="op">$</span>basetable[[x]] &lt;-<span class="st"> </span><span class="ot">NULL</span> <span class="co"># remove unnecessary columns</span>
P<span class="op">$</span>basetable[[<span class="st">"stage_type"</span>]] &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(P<span class="op">$</span>basetable[[<span class="st">"stage_type"</span>]]), <span class="st">"speech"</span>, <span class="st">"interjection"</span>)</code></pre></div>
<p>Take appart the basetable, and save results to csv subdir.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">P<span class="op">$</span><span class="kw">dissectBastable</span>(<span class="dt">targetDir =</span> <span class="st">"csv"</span>)
P<span class="op">$</span><span class="kw">size</span>()</code></pre></div>
</div>
<div id="error-correction" class="section level1">
<h1 class="hasAnchor">
<a href="#error-correction" class="anchor"></a>Error correction</h1>
<p>At this stage, some replacements are performed, to avoid tokenisation errors and unwanted “&lt;” signs that would result from Stanford CoreNLP.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dt &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="kw">file.path</span>(pipeDir, <span class="st">"csv"</span>, <span class="st">"texttable.csv"</span>))
replacements &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="kw">c</span>(<span class="st">"a&lt;`"</span>, <span class="st">"à"</span>), <span class="co">#</span>
  <span class="kw">c</span>(<span class="st">"e&lt;'"</span>, <span class="st">"é"</span>),
  <span class="kw">c</span>(<span class="st">"o&lt;</span><span class="ch">\\</span><span class="st">^"</span>, <span class="st">"\u00F4"</span>),
  <span class="kw">c</span>(<span class="st">"Milo&lt;vsevi&lt;'c"</span>, <span class="st">"Milosevic"</span>),
  <span class="kw">c</span>(<span class="st">"s&lt;v"</span>, <span class="st">"\u0161"</span>),
  <span class="kw">c</span>(<span class="st">"a&lt;'"</span>, <span class="st">"á"</span>),
  <span class="kw">c</span>(<span class="st">"Bene&lt;vs"</span>, <span class="st">"Bene\u0161"</span>),
  <span class="kw">c</span>(<span class="st">"D&lt;i&lt;'ez-Hochleitner"</span>, <span class="st">"Díez-Hochleitner"</span>),
  <span class="kw">c</span>(<span class="st">"e&lt;`"</span>, <span class="st">"è"</span>),
  <span class="kw">c</span>(<span class="st">"o&lt;'"</span>, <span class="st">"ó"</span>),
  <span class="kw">c</span>(<span class="st">"z&lt;v"</span>, <span class="st">"ž"</span>),
  <span class="kw">c</span>(<span class="st">"c&lt;'"</span>, <span class="st">"ć"</span>),
  <span class="kw">c</span>(<span class="st">"Karad&lt;vzi"</span>, <span class="st">"Karadži")</span>
<span class="st">)</span>
<span class="st">pb &lt;- txtProgressBar(min = 1, max = length(replacements), style = 3)</span>
<span class="st">for (i in 1:length(replacements)){</span>
<span class="st">  setTxtProgressBar(pb, i)</span>
<span class="st">  dt[, text := gsub(replacements[[i]][1], replacements[[i]][2], dt[["</span>text<span class="st">"]])]</span>
<span class="st">}</span>
<span class="st">close(pb)</span>
<span class="st">data.table::fwrite(dt, file = file.path(pipeDir, "</span>csv<span class="st">", "</span>texttable2.csv<span class="st">"))</span></code></pre></div>
</div>
<div id="annotation-using-stanford-corenlp" class="section level1">
<h1 class="hasAnchor">
<a href="#annotation-using-stanford-corenlp" class="anchor"></a>Annotation using Stanford CoreNLP</h1>
<p>Here we do the actual annotation, the most time consuming part of the exercies. Parallelisation is possible, but will require seperate JVMs to be created by forked processes. It will fail, if a JVM has been initialized by R before that - take care.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="kw">is.null</span>(P<span class="op">$</span>texttable)) P<span class="op">$</span>texttable &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="kw">file.path</span>(pipeDir, <span class="st">"csv"</span>, <span class="st">"texttable.csv"</span>))
P<span class="op">$</span><span class="kw">corenlp</span>(<span class="dt">sourceDir =</span> <span class="st">"csv"</span>, <span class="dt">targetDir =</span> <span class="st">"ndjson"</span>)</code></pre></div>
</div>
<div id="turn-ndjson-to-csv" class="section level1">
<h1 class="hasAnchor">
<a href="#turn-ndjson-to-csv" class="anchor"></a>turn NDJSON to csv</h1>
<p>We have ‘ndjson’ output at this stage. This needs to be turned into a vertical / tabular format. No parallelization here so far, as the procedure is sufficiently fast (~ 1,5 h).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">P<span class="op">$</span><span class="kw">ndjsonToDf</span>(<span class="dt">sourceDir =</span> <span class="st">"ndjson"</span>, <span class="dt">targetDir =</span> <span class="st">"csv"</span>)</code></pre></div>
</div>
<div id="treetagging" class="section level1">
<h1 class="hasAnchor">
<a href="#treetagging" class="anchor"></a>treetagging</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">P<span class="op">$</span>tokenstream &lt;-<span class="st">  </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"csv"</span>, <span class="st">"tokenstream.csv"</span>))
P<span class="op">$</span>tokenstream &lt;-<span class="st"> </span>P<span class="op">$</span>tokenstream[<span class="op">!</span><span class="kw">is.na</span>(P<span class="op">$</span>tokenstream[[<span class="st">"word"</span>]])] <span class="co"># take care of NAs!!</span>
<span class="co"># fwrite used here, because it is much, much faster than cat</span>
data.table<span class="op">::</span><span class="kw">fwrite</span>(
  P<span class="op">$</span>tokenstream[, <span class="st">"word"</span>, <span class="dt">with =</span> <span class="ot">TRUE</span>],
  <span class="dt">file =</span> <span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"tok"</span>, <span class="st">"tokenstream.tok"</span>),
  <span class="dt">col.names =</span> <span class="ot">FALSE</span>,
  <span class="dt">quote =</span> <span class="ot">FALSE</span>, <span class="dt">showProgress =</span> <span class="ot">TRUE</span>
  )
P<span class="op">$</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ctk/topics/treetagger">treetagger</a></span>(<span class="dt">sourceDir =</span> <span class="st">"tok"</span>, <span class="dt">targetDir =</span> <span class="st">"vrt"</span>) <span class="co"># roughly 5 minutes</span>
treetaggerOutput &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(
  <span class="kw">file.path</span>(pipeDir, <span class="st">"vrt"</span>, <span class="st">"tokenstream.vrt"</span>), <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,
  <span class="dt">col.names =</span> <span class="kw">c</span>(<span class="st">"word"</span>, <span class="st">"pos"</span>, <span class="st">"lemma"</span>)
  )
P<span class="op">$</span>tokenstream[, lemma <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"im"</span>, treetaggerOutput[[<span class="st">"lemma"</span>]]) ]
data.table<span class="op">::</span><span class="kw">fwrite</span>(P<span class="op">$</span>tokenstream, <span class="dt">file =</span> <span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"csv"</span>, <span class="st">"tokenstream2.csv"</span>), <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)</code></pre></div>
</div>
<div id="import-corpus-into-cwb" class="section level1">
<h1 class="hasAnchor">
<a href="#import-corpus-into-cwb" class="anchor"></a>Import corpus into CWB</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Enc &lt;-<span class="st"> </span>Encoder<span class="op">$</span><span class="kw">new</span>(<span class="dt">corpus =</span> <span class="st">"germaparl2"</span>)
Enc<span class="op">$</span>pAttrDT &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"csv"</span>, <span class="st">"tokenstream2.csv"</span>), <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)
Enc<span class="op">$</span>sAttrDT &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="kw">file.path</span>(P<span class="op">$</span>dir, <span class="st">"csv"</span>, <span class="st">"metadata.csv"</span>))

data.table<span class="op">::</span><span class="kw">setnames</span>(Enc<span class="op">$</span>sAttrDT, <span class="dt">old =</span> <span class="kw">c</span>(<span class="st">"sp_party"</span>, <span class="st">"sp_name"</span>), <span class="dt">new =</span> <span class="kw">c</span>(<span class="st">"party"</span>, <span class="st">"name"</span>))

Enc<span class="op">$</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ctk/topics/encode-method">encode</a></span>(
  <span class="dt">pAttributes =</span> <span class="kw">c</span>(<span class="st">"word"</span>, <span class="st">"pos"</span>, <span class="st">"lemma"</span>),
  <span class="dt">sAttributes =</span> <span class="kw">c</span>(<span class="st">"party"</span>, <span class="st">"name"</span>, <span class="st">"lp"</span>, <span class="st">"session"</span>, <span class="st">"date"</span>)
  )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">use</span>() <span class="co"># to make the new corpus available</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#setting-parameters-and-global-variables">Setting parameters and global variables</a></li>
      <li><a href="#initialize-pipe">Initialize Pipe</a></li>
      <li><a href="#generate-basetable">Generate Basetable</a></li>
      <li><a href="#error-correction">Error correction</a></li>
      <li><a href="#annotation-using-stanford-corenlp">Annotation using Stanford CoreNLP</a></li>
      <li><a href="#turn-ndjson-to-csv">turn NDJSON to csv</a></li>
      <li><a href="#treetagging">treetagging</a></li>
      <li><a href="#import-corpus-into-cwb">Import corpus into CWB</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Andreas Blaette Developer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
